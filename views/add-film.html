<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add Film | MyMovie</title>
  <link rel="stylesheet" href="/main.css" />
  <style>
    .add-form {
      max-width: 600px;
      margin: 0 auto;
      background: var(--bg-secondary);
      padding: 2rem;
      border-radius: 8px;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 0.875rem 1rem;
      background-color: var(--bg-input);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color var(--transition-fast);
    }
    
    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent-green);
    }
    
    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--text-muted);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    
    .btn-submit {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
    }

    .recent-films {
      margin-top: 3rem;
    }

    .film-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .film-table th,
    .film-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-subtle);
    }

    .film-table th {
      background-color: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .film-table tr:hover {
      background-color: var(--bg-hover);
    }

    .film-table .poster-thumb {
      width: 40px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }

    .film-table .poster-placeholder {
      width: 40px;
      height: 60px;
      background: var(--bg-card);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .btn-small {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
    }

    .sort-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .sort-controls label {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .sort-select {
      padding: 0.5rem 1rem;
      background-color: var(--bg-input);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    .form-checkboxes { display: flex; flex-wrap: wrap; gap: 0.75rem 1.5rem; }
    .form-checkboxes label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem; color: var(--text-secondary); }
    .form-checkboxes input[type="checkbox"] { width: auto; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <a href="/" class="nav-brand">
        <span class="nav-logo">My<span>Movie</span></span>
      </a>
      
      <div class="nav-links">
        <a href="/" class="nav-link">Home</a>
        <a href="/films" class="nav-link">Films</a>
        <a href="/add-film" id="nav-add-film" class="nav-link active">Add Film</a>
        <a href="/watchlist" class="nav-link">Watchlist</a>
        <a href="/profile" class="nav-link">Profile</a>
      </div>
      
      <div class="nav-search">
        <input type="text" id="search-input" placeholder="Search films..." onkeypress="if(event.key==='Enter')window.location.href='/films?search='+encodeURIComponent(this.value)" />
      </div>
      
      <div class="nav-actions">
        <span id="nav-user" class="nav-link hidden"></span>
        <a href="/login" id="nav-login" class="nav-link">Sign In</a>
        <a href="/register" id="nav-signup" class="nav-link">Sign Up</a>
        <a href="#" id="nav-logout" class="nav-link hidden" onclick="logout(event)">Logout</a>
        <a href="/about" class="nav-icon" title="About">?</a>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  <section class="hero" style="padding: 2rem 0;">
    <div class="container">
      <h1>Add New Film</h1>
      <p>Add a film to the database</p>
      <p id="sign-in-msg" class="section-title hidden" style="border:none; color: var(--accent-orange);">Please sign in to modify data.</p>
      <p id="admin-msg" class="section-title hidden" style="border:none; color: var(--accent-orange);">Only admin can manage movies.</p>
    </div>
  </section>

  <!-- Main Content -->
  <main class="page-content">
    <div class="container">
      
      <!-- Add Film Form -->
      <form class="add-form" id="add-film-form">
        <div class="form-row">
          <div class="form-group">
            <label for="title" class="form-label">Title *</label>
            <input type="text" id="title" name="title" class="form-input" placeholder="Film title" required />
          </div>
          <div class="form-group">
            <label for="year" class="form-label">Year *</label>
            <input type="number" id="year" name="year" class="form-input" placeholder="2024" min="1888" max="2100" required />
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Genres</label>
          <div id="genres-checkboxes" class="form-checkboxes">
            <label><input type="checkbox" name="genre" value="Action" /> Action</label>
            <label><input type="checkbox" name="genre" value="Adventure" /> Adventure</label>
            <label><input type="checkbox" name="genre" value="Animation" /> Animation</label>
            <label><input type="checkbox" name="genre" value="Comedy" /> Comedy</label>
            <label><input type="checkbox" name="genre" value="Crime" /> Crime</label>
            <label><input type="checkbox" name="genre" value="Drama" /> Drama</label>
            <label><input type="checkbox" name="genre" value="Fantasy" /> Fantasy</label>
            <label><input type="checkbox" name="genre" value="Horror" /> Horror</label>
            <label><input type="checkbox" name="genre" value="Mystery" /> Mystery</label>
            <label><input type="checkbox" name="genre" value="Romance" /> Romance</label>
            <label><input type="checkbox" name="genre" value="Sci-Fi" /> Sci-Fi</label>
            <label><input type="checkbox" name="genre" value="Thriller" /> Thriller</label>
            <label><input type="checkbox" name="genre" value="Documentary" /> Documentary</label>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="rating" class="form-label">Rating (0‚Äì10)</label>
            <input type="number" id="rating" name="rating" class="form-input" placeholder="‚Äî" min="0" max="10" step="0.5" />
          </div>
          <div class="form-group">
            <label for="director" class="form-label">Director</label>
            <input type="text" id="director" name="director" class="form-input" placeholder="Director name" />
          </div>
        </div>
        
        <div class="form-group">
          <label for="poster" class="form-label">Poster URL</label>
          <input type="url" id="poster" name="poster" class="form-input" placeholder="https://example.com/poster.jpg" />
          <p class="form-hint">Direct link to the movie poster image</p>

          <label for="trailerUrl" class="form-label">Trailer URL</label>
          <input type="url" id="trailerUrl" name="trailerUrl" class="form-input" placeholder="https://example.com/trailer" />
          <p class="form-hint">Link to the trailer (external site)</p>
        </div>
        
        <div class="form-group">
          <label for="description" class="form-label">Description</label>
          <textarea id="description" name="description" class="form-textarea" placeholder="Brief description of the film..."></textarea>
        </div>
        
        <div id="form-error" class="form-hint" style="color: var(--accent-red); display: none;"></div>
        <button type="submit" class="btn btn-primary btn-submit" id="submit-btn">Add Film</button>
      </form>

      <!-- Recent Films Table -->
      <section class="recent-films">
        <h2 class="section-title">All Films</h2>
        
        <!-- Sort Controls -->
        <div class="sort-controls">
          <label for="sort-select">Sort by:</label>
          <select id="sort-select" class="sort-select" onchange="loadFilms()">
            <option value="createdAt:desc">Recently Added</option>
            <option value="year:desc">Year (Newest)</option>
            <option value="year:asc">Year (Oldest)</option>
            <option value="title:asc">Title (A-Z)</option>
            <option value="title:desc">Title (Z-A)</option>
            <option value="rating:desc">Rating (high to low)</option>
            <option value="rating:asc">Rating (low to high)</option>
          </select>
          <label for="filter-genre">Genre:</label>
          <select id="filter-genre" class="sort-select" onchange="loadFilms()">
            <option value="">All Genres</option>
            <option value="Action">Action</option>
            <option value="Adventure">Adventure</option>
            <option value="Animation">Animation</option>
            <option value="Comedy">Comedy</option>
            <option value="Crime">Crime</option>
            <option value="Drama">Drama</option>
            <option value="Fantasy">Fantasy</option>
            <option value="Horror">Horror</option>
            <option value="Mystery">Mystery</option>
            <option value="Romance">Romance</option>
            <option value="Sci-Fi">Sci-Fi</option>
            <option value="Thriller">Thriller</option>
            <option value="Documentary">Documentary</option>
          </select>
        </div>

        <div id="films-table-container">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p class="footer-text">&copy; 2026 MyMovie</p>
        <div class="footer-links">
          <a href="/about" class="footer-link">About</a>
          <a href="/contact" class="footer-link">Contact</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <span id="toast-message"></span>
  </div>

  <script>
    const API_BASE = '/api/movies';
    const AUTH_ME = '/auth/me';
    let editingId = null;
    let isLoggedIn = false;
    let isAdmin = false;

    function fetchOpts() { return { credentials: 'include' }; }

    async function checkAuth() {
      try {
        const res = await fetch(AUTH_ME, fetchOpts());
        isLoggedIn = res.ok;
        const navLogin = document.getElementById('nav-login');
        const navLogout = document.getElementById('nav-logout');
        const navUser = document.getElementById('nav-user');
        const navAddFilm = document.getElementById('nav-add-film');
        const navSignup = document.getElementById('nav-signup');
        const signInMsg = document.getElementById('sign-in-msg');
        const adminMsg = document.getElementById('admin-msg');
        const form = document.getElementById('add-film-form');
        if (isLoggedIn) {
          const data = await res.json();
          isAdmin = data.user?.role === 'admin';
          navUser.textContent = data.user?.username || '';
          navUser.classList.remove('hidden');
          navLogin.classList.add('hidden');
          navSignup.classList.add('hidden');
          navLogout.classList.remove('hidden');
          if (navAddFilm && !isAdmin) navAddFilm.classList.add('hidden');
          if (isAdmin) {
            signInMsg.classList.add('hidden');
            adminMsg.classList.add('hidden');
            form.querySelectorAll('input, textarea, button').forEach(el => { el.disabled = false; });
          } else {
            signInMsg.classList.add('hidden');
            adminMsg.classList.remove('hidden');
            form.querySelectorAll('input, textarea, button').forEach(el => { el.disabled = true; });
          }
        } else {
          isAdmin = false;
          if (navAddFilm) navAddFilm.classList.remove('hidden');
          signInMsg.classList.remove('hidden');
          adminMsg.classList.add('hidden');
          form.querySelectorAll('input, textarea, button').forEach(el => { el.disabled = true; });
        }
      } catch (_) {
        isLoggedIn = false;
        isAdmin = false;
      }
    }

    async function logout(e) {
      e.preventDefault();
      await fetch('/auth/logout', { method: 'POST', ...fetchOpts() });
      isLoggedIn = false;
      isAdmin = false;
      window.location.href = '/';
    }

    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadFilms();
      const genreBox = document.getElementById('genres-checkboxes');
      if (genreBox) {
        genreBox.addEventListener('change', () => {
          const checked = genreBox.querySelectorAll('input[name="genre"]:checked');
          const max = 6;
          genreBox.querySelectorAll('input[name="genre"]').forEach(cb => {
            cb.disabled = !cb.checked && checked.length >= max;
          });
        });
      }
    });

    function getGenresDisplay(film) {
      const g = film.genres && Array.isArray(film.genres) ? film.genres : (film.genre ? [film.genre] : []);
      return g.length ? g.join(', ') : '‚Äî';
    }

    function getRatingDisplay(film) {
      const r = film.rating;
      if (r === undefined || r === null || r === '') return '‚Äî';
      const n = Number(r);
      if (Number.isNaN(n)) return '‚Äî';
      return n;
    }

    async function loadFilms() {
      const container = document.getElementById('films-table-container');
      const sort = document.getElementById('sort-select').value;
      const genre = document.getElementById('filter-genre').value;
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      try {
        const params = new URLSearchParams();
        if (sort) params.append('sort', sort);
        if (genre) params.append('genre', genre);
        params.append('limit', '200');
        const url = params.toString() ? `${API_BASE}?${params}` : API_BASE;
        const response = await fetch(url, fetchOpts());
        const data = await response.json();
        const films = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
        if (films.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üé¨</div><h3>No films yet</h3><p>Add your first film using the form above</p></div>';
          return;
        }
        const actionsCell = (film) => isAdmin
          ? `<div class="btn-group"><button class="btn btn-secondary btn-small" onclick="editFilm('${film._id}')">Edit</button><button class="btn btn-danger btn-small" onclick="deleteFilm('${film._id}')">Delete</button></div>`
          : '‚Äî';
        container.innerHTML = `
          <table class="film-table">
            <thead><tr><th>Poster</th><th>Title</th><th>Year</th><th>Genres</th><th>Rating</th><th>Actions</th></tr></thead>
            <tbody>
              ${films.map(film => `
                <tr>
                  <td>${film.poster || film.posterUrl ? `<img src="${film.poster || film.posterUrl}" class="poster-thumb" alt="${escapeHtml(film.title)}" onerror="this.outerHTML='<div class=\\'poster-placeholder\\'>${getInitials(film.title)}</div>'">` : `<div class="poster-placeholder">${getInitials(film.title)}</div>`}</td>
                  <td><a href="/films/${film._id}" style="color: var(--text-primary);">${escapeHtml(film.title)}</a></td>
                  <td>${film.year || '‚Äî'}</td>
                  <td>${escapeHtml(getGenresDisplay(film))}</td>
                  <td>${getRatingDisplay(film)}</td>
                  <td>${actionsCell(film)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Error loading films</h3></div>';
      }
    }

    document.getElementById('add-film-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorEl = document.getElementById('form-error');
      errorEl.style.display = 'none';
      errorEl.textContent = '';
      if (!isAdmin) {
        errorEl.textContent = 'Only admin can manage movies.';
        errorEl.style.display = 'block';
        return;
      }
      const genreChecks = document.querySelectorAll('#genres-checkboxes input[name="genre"]:checked');
      const genres = Array.from(genreChecks).map(c => c.value).slice(0, 6);
      const ratingRaw = document.getElementById('rating').value.trim();
      const rating = ratingRaw === '' ? undefined : parseFloat(ratingRaw);
      const titleVal = document.getElementById('title').value.trim();
      const yearVal = parseInt(document.getElementById('year').value, 10);
      const currentYear = new Date().getFullYear();
      const errors = [];
      if (!titleVal) errors.push('Title is required');
      if (!Number.isInteger(yearVal) || yearVal < 1888 || yearVal > currentYear + 1) {
        errors.push(`Year must be between 1888 and ${currentYear + 1}`);
      }
      if (!genres.length || genres.length > 6) errors.push('Select 1‚Äì6 genres');
      if (rating !== undefined && (Number.isNaN(rating) || rating < 0 || rating > 10)) {
        errors.push('Rating must be between 0 and 10');
      }
      if (errors.length) {
        errorEl.textContent = errors.join('. ');
        errorEl.style.display = 'block';
        return;
      }
      const filmData = {
        title: titleVal,
        year: yearVal,
        genres: genres.length ? genres : undefined,
        rating: rating !== undefined && !Number.isNaN(rating) ? rating : undefined,
        director: document.getElementById('director').value.trim() || undefined,
        posterUrl: document.getElementById('poster').value.trim() || undefined,
        trailerUrl: document.getElementById('trailerUrl').value.trim() || undefined,
        description: document.getElementById('description').value.trim() || undefined
      };
      try {
        const isUpdate = !!editingId;
        const url = isUpdate ? `${API_BASE}/${editingId}` : API_BASE;
        const method = isUpdate ? 'PUT' : 'POST';
        const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(filmData) });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          if (response.status === 401) { showToast('Please sign in to modify data.', 'error'); return; }
          if (response.status === 403) { showToast('Only admin can manage movies.', 'error'); return; }
          if (response.status === 400) {
            errorEl.textContent = data.message ? `${data.message}${Array.isArray(data.errors) ? ': ' + data.errors.join(', ') : ''}` : 'Validation error';
            errorEl.style.display = 'block';
            return;
          }
          throw new Error(data.message || data.error || 'Operation failed');
        }
        showToast(isUpdate ? 'Film updated!' : 'Film added!', 'success');
        resetForm();
        loadFilms();
      } catch (err) {
        showToast(err.message || 'Error', 'error');
      }
    });

    async function editFilm(id) {
      if (!isAdmin) { showToast('Only admin can manage movies.', 'error'); return; }
      try {
        const response = await fetch(`${API_BASE}/${id}`, fetchOpts());
        const film = await response.json();
        document.getElementById('title').value = film.title || '';
        document.getElementById('year').value = film.year || '';
        document.querySelectorAll('#genres-checkboxes input[name="genre"]').forEach(cb => {
          const g = film.genres && Array.isArray(film.genres) ? film.genres : (film.genre ? [film.genre] : []);
          cb.checked = g.includes(cb.value);
        });
        document.getElementById('rating').value = film.rating !== undefined && film.rating !== null ? film.rating : '';
        document.getElementById('director').value = film.director || '';
        document.getElementById('poster').value = film.poster || film.posterUrl || '';
        document.getElementById('trailerUrl').value = film.trailerUrl || film.watchUrl || '';
        document.getElementById('description').value = film.description || '';
        editingId = id;
        document.getElementById('submit-btn').textContent = 'Update Film';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) {
        showToast('Error loading film', 'error');
      }
    }

    async function deleteFilm(id) {
      if (!confirm('Are you sure you want to delete this film?')) return;
      if (!isAdmin) { showToast('Only admin can manage movies.', 'error'); return; }
      try {
        const response = await fetch(`${API_BASE}/${id}`, { method: 'DELETE', ...fetchOpts() });
        if (response.status === 401) { showToast('Please sign in to modify data.', 'error'); loadFilms(); return; }
        if (response.status === 403) { showToast('Only admin can manage movies.', 'error'); loadFilms(); return; }
        if (!response.ok) throw new Error('Failed to delete');
        showToast('Film deleted', 'success');
        loadFilms();
      } catch (err) {
        showToast('Error deleting film', 'error');
      }
    }

    function resetForm() {
      document.getElementById('add-film-form').reset();
      editingId = null;
      document.getElementById('submit-btn').textContent = 'Add Film';
    }

    function getInitials(title) { return String(title).split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase(); }
    function showToast(message, type) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-message').textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
    function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
  </script>
</body>
</html>
