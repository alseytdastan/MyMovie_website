<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Film Details | MyMovie</title>
  <link rel="stylesheet" href="/main.css" />
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <a href="/" class="nav-brand">
        <span class="nav-logo">My<span>Movie</span></span>
      </a>
      
      <div class="nav-links">
        <a href="/" class="nav-link">Home</a>
        <a href="/films" class="nav-link active">Films</a>
        <a href="/add-film" id="nav-add-film" class="nav-link">Add Film</a>
        <a href="/watchlist" class="nav-link">Watchlist</a>
        <a href="/profile" class="nav-link">Profile</a>
      </div>
      
      <div class="nav-search">
        <input type="text" id="search-input" placeholder="Search films..." onkeypress="if(event.key==='Enter')window.location.href='/films?search='+encodeURIComponent(this.value)" />
      </div>
      
      <div class="nav-actions">
        <span id="nav-user" class="nav-link hidden" style="font-size:0.875rem;"></span>
        <a href="/login" id="nav-login" class="nav-link">Sign In</a>
        <a href="/register" id="nav-signup" class="nav-link">Sign Up</a>
        <a href="#" id="nav-logout" class="nav-link hidden" onclick="doLogout(event)">Logout</a>
        <a href="/about" class="nav-icon" title="About">?</a>
      </div>
    </div>
  </nav>

  <!-- Film Header -->
  <section class="film-header">
    <div id="backdrop-container"></div>
    <div class="container">
      <div class="film-content">
        <!-- Poster -->
        <div class="film-poster" id="film-poster">
          <div class="skeleton" style="width: 100%; aspect-ratio: 2/3;"></div>
        </div>
        
        <!-- Info -->
        <div class="film-info" id="film-info">
          <div class="skeleton" style="height: 40px; width: 60%; margin-bottom: 1rem;"></div>
          <div class="skeleton" style="height: 20px; width: 40%; margin-bottom: 1rem;"></div>
          <div class="skeleton" style="height: 100px; width: 100%; margin-bottom: 1rem;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="page-content">
    <div class="container">
      
      <!-- Similar Films -->
      <section class="mb-4" id="similar-section" style="display: none;">
        <h2 class="section-title">More Like This</h2>
        <div class="poster-grid" id="similar-grid"></div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p class="footer-text">&copy; 2026 MyMovie</p>
        <div class="footer-links">
          <a href="/about" class="footer-link">About</a>
          <a href="/contact" class="footer-link">Contact</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <span id="toast-message"></span>
  </div>

  <script>
    const API_BASE = '/api/movies';
    let watchlist = [];
    let likes = [];
    let currentFilm = null;
    let isLoggedIn = false;
    let currentUser = null;

    function fetchOpts() { return { credentials: 'include' }; }

    function getFilmId() {
      const path = window.location.pathname;
      const parts = path.split('/');
      return parts[parts.length - 1];
    }

    async function checkAuth() {
      try {
        const res = await fetch('/auth/me', fetchOpts());
        isLoggedIn = res.ok;
        const navUser = document.getElementById('nav-user');
        const navLogin = document.getElementById('nav-login');
        const navLogout = document.getElementById('nav-logout');
        const navSignup = document.getElementById('nav-signup');
        const navAddFilm = document.getElementById('nav-add-film');
        if (res.ok) {
          const data = await res.json();
          currentUser = data.user || null;
          navUser.textContent = data.user?.username || '';
          navUser.classList.remove('hidden');
          navLogin.classList.add('hidden');
          navSignup.classList.add('hidden');
          navLogout.classList.remove('hidden');
          if (navAddFilm) navAddFilm.classList.toggle('hidden', data.user?.role !== 'admin');
        } else {
          currentUser = null;
          navUser.classList.add('hidden');
          navLogin.classList.remove('hidden');
          navSignup.classList.remove('hidden');
          navLogout.classList.add('hidden');
          if (navAddFilm) navAddFilm.classList.add('hidden');
        }
      } catch (_) {
        isLoggedIn = false;
      }
    }

    async function loadUserLists() {
      if (!isLoggedIn) {
        watchlist = [];
        likes = [];
        return;
      }
      try {
        const [likesRes, watchRes] = await Promise.all([
          fetch('/api/user/likes', fetchOpts()),
          fetch('/api/user/watchlist', fetchOpts()),
        ]);
        const likesData = await likesRes.json().catch(() => ({}));
        const watchData = await watchRes.json().catch(() => ({}));
        if (likesRes.ok) likes = Array.isArray(likesData.items) ? likesData.items : [];
        if (watchRes.ok) watchlist = Array.isArray(watchData.items) ? watchData.items : [];
      } catch (_) {
        likes = [];
        watchlist = [];
      }
    }

    async function doLogout(e) {
      e.preventDefault();
      await fetch('/auth/logout', { method: 'POST', ...fetchOpts() });
      watchlist = [];
      likes = [];
      currentUser = null;
      window.location.href = '/';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuth();
      await loadUserLists();
      loadFilm();
    });

    // Load film details
    async function loadFilm() {
      const filmId = getFilmId();
      
      try {
        const response = await fetch(`${API_BASE}/${filmId}`, fetchOpts());
        if (!response.ok) {
          throw new Error('Film not found');
        }
        
        currentFilm = await response.json();
        displayFilm(currentFilm);
        const genreForSimilar = (currentFilm.genres && currentFilm.genres[0]) || currentFilm.genre;
        loadSimilarFilms(genreForSimilar);
        
        // Update page title
        document.title = `${currentFilm.title} (${currentFilm.year || 'N/A'}) | MyMovie`;
      } catch (error) {
        console.error('Error loading film:', error);
        displayError();
      }
    }

    // Display film details
    function displayFilm(film) {
      const isLiked = likes.includes(film._id);
      const isWatchlisted = watchlist.includes(film._id);
      
      // Poster
      const posterEl = document.getElementById('film-poster');
      if (film.poster || film.posterUrl) {
        posterEl.innerHTML = `<img src="${film.poster || film.posterUrl}" alt="${escapeHtml(film.title)}" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>${getInitials(film.title)}</div>'">`;
      } else {
        posterEl.innerHTML = `<div class="placeholder">${getInitials(film.title)}</div>`;
      }
      
      // Backdrop (if poster exists, use it faded)
      if (film.poster || film.posterUrl) {
        const backdropContainer = document.getElementById('backdrop-container');
        backdropContainer.innerHTML = `<img class="film-backdrop" src="${film.poster || film.posterUrl}" alt="">`;
      }
      
      const genresArr = (film.genres && film.genres.length) ? film.genres : (film.genre ? String(film.genre).split(',').map(g => g.trim()).filter(Boolean) : []);
      const ratingDisplay = (film.rating != null && film.rating !== '') ? Number(film.rating) + ' / 10' : '—';
      const infoEl = document.getElementById('film-info');
      infoEl.innerHTML = `
        <h1>${escapeHtml(film.title)}</h1>
        
        <div class="film-meta">
          <span>${film.year || 'Year unknown'}</span>
          ${film.director ? `<span>•</span><span>${escapeHtml(film.director)}</span>` : ''}
          ${ratingDisplay !== '—' ? `<span>•</span><span>${ratingDisplay}</span>` : ''}
        </div>
        
        ${genresArr.length ? `
        <div class="film-genres">
          ${genresArr.map(g => `<span class="genre-tag">${escapeHtml(g)}</span>`).join('')}
        </div>
        ` : ''}
        
        ${film.description ? `
        <p class="film-description">${escapeHtml(film.description)}</p>
        ` : `
        <p class="film-description" style="color: var(--text-muted); font-style: italic;">No description available.</p>
        `}
        
        <div class="film-actions">
          ${isLoggedIn ? `
          <button class="btn ${isWatchlisted ? 'btn-primary' : 'btn-secondary'}" onclick="toggleWatchlist('${film._id}')">${isWatchlisted ? '✓ In Watchlist' : '+ Add to Watchlist'}</button>
          <button class="btn ${isLiked ? 'btn-primary' : 'btn-secondary'}" onclick="toggleLike('${film._id}')">♥ ${isLiked ? 'Liked' : 'Like'}</button>
          ${film.watchUrl ? `<a class="btn btn-secondary" href="${escapeHtml(film.watchUrl)}" target="_blank" rel="noopener">▶ Watch Film</a>` : ''}
          ` : `
          <button class="btn btn-secondary" onclick="window.location.href='/login'">+ Add to Watchlist (Sign in)</button>
          <button class="btn btn-secondary" onclick="window.location.href='/login'">♥ Like (Sign in)</button>
          ${film.watchUrl ? `<a class="btn btn-secondary" href="${escapeHtml(film.watchUrl)}" target="_blank" rel="noopener">▶ Watch Film</a>` : ''}
          `}
        </div>
        
        <div class="mt-4">
          <p class="section-title" style="border: none; padding: 0; margin-bottom: 0.5rem;">Film ID</p>
          <code style="background: var(--bg-card); padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.75rem; color: var(--text-muted);">${film._id}</code>
        </div>
      `;
    }

    // Load similar films
    async function loadSimilarFilms(genre) {
      if (!genre) return;
      
      try {
        const response = await fetch(`${API_BASE}?genre=${encodeURIComponent(genre)}`, fetchOpts());
        const data = await response.json();
        const movies = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : []);
        
        // Filter out current film and limit to 6
        const similar = movies.filter(m => m._id !== currentFilm._id).slice(0, 6);
        
        if (similar.length === 0) return;
        
        document.getElementById('similar-section').style.display = 'block';
        document.getElementById('similar-grid').innerHTML = similar.map(movie => createPosterCard(movie)).join('');
      } catch (error) {
        console.error('Error loading similar films:', error);
      }
    }

    function createPosterCard(movie) {
      const isLiked = likes.includes(movie._id);
      const isWatchlisted = watchlist.includes(movie._id);
      const posterContent = movie.poster || movie.posterUrl 
        ? `<img src="${movie.poster || movie.posterUrl}" alt="${escapeHtml(movie.title)}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>${getInitials(movie.title)}</div>'">`
        : `<div class="placeholder">${getInitials(movie.title)}</div>`;
      const actionsHtml = isLoggedIn
        ? `<div class="poster-actions"><button class="poster-action ${isWatchlisted ? 'watchlisted' : ''}" onclick="event.preventDefault(); toggleWatchlist('${movie._id}')" title="${isWatchlisted ? 'Remove from Watchlist' : 'Add to Watchlist'}">${isWatchlisted ? '✓' : '+'}</button><button class="poster-action ${isLiked ? 'liked' : ''}" onclick="event.preventDefault(); toggleLike('${movie._id}')" title="${isLiked ? 'Unlike' : 'Like'}">♥</button></div>`
        : `<div class="poster-actions"><button class="poster-action" onclick="event.preventDefault(); window.location.href='/login'" title="Sign in to add to watchlist">+</button><button class="poster-action" onclick="event.preventDefault(); window.location.href='/login'" title="Sign in to like">♥</button></div>`;
      return `<a href="/films/${movie._id}" class="poster-card">${posterContent}<div class="poster-overlay"><span class="poster-title">${escapeHtml(movie.title)}</span><span class="poster-year">${movie.year || 'N/A'}</span></div>${actionsHtml}</a>`;
    }

    // Display error
    function displayError() {
      document.getElementById('film-poster').innerHTML = `<div class="placeholder">?</div>`;
      document.getElementById('film-info').innerHTML = `
        <h1>Film Not Found</h1>
        <p class="film-description">The film you're looking for doesn't exist or has been removed.</p>
        <div class="film-actions">
          <a href="/films" class="btn btn-primary">Browse Films</a>
          <a href="/" class="btn btn-secondary">Go Home</a>
        </div>
      `;
    }

    // Get initials from title
    function getInitials(title) {
      return title.split(' ').map(word => word[0]).join('').slice(0, 2).toUpperCase();
    }

    // Toggle watchlist
    async function toggleWatchlist(movieId) {
      if (!isLoggedIn) { window.location.href = '/login'; return; }
      const isInList = watchlist.includes(movieId);
      const url = isInList ? `/api/user/watchlist/${movieId}` : '/api/user/watchlist';
      const options = {
        method: isInList ? 'DELETE' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: isInList ? undefined : JSON.stringify({ movieId }),
      };
      try {
        const res = await fetch(url, options);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Error');
        watchlist = Array.isArray(data.items) ? data.items : [];
        showToast(isInList ? 'Removed from watchlist' : 'Added to watchlist');
        if (currentFilm && movieId === currentFilm._id) displayFilm(currentFilm);
        loadSimilarFilms(currentFilm?.genre);
      } catch (err) {
        showToast(err.message || 'Error', 'error');
      }
    }

    // Toggle like
    async function toggleLike(movieId) {
      if (!isLoggedIn) { window.location.href = '/login'; return; }
      const isInList = likes.includes(movieId);
      const url = isInList ? `/api/user/likes/${movieId}` : '/api/user/likes';
      const options = {
        method: isInList ? 'DELETE' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: isInList ? undefined : JSON.stringify({ movieId }),
      };
      try {
        const res = await fetch(url, options);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Error');
        likes = Array.isArray(data.items) ? data.items : [];
        showToast(isInList ? 'Removed like' : 'Liked!', 'success');
        if (currentFilm && movieId === currentFilm._id) displayFilm(currentFilm);
        loadSimilarFilms(currentFilm?.genre);
      } catch (err) {
        showToast(err.message || 'Error', 'error');
      }
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toastMessage.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
